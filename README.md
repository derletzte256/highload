# Twitch
## 1. Тема и целевая аудитория
**Тема** - стриминговый сервис
### Функционал MVP:
- Регистрация/авторизация
- Создание стрима (включая установление соединение для стриминга видео)
- Просмотр стрима (включая стриминг видео)
- Подписка
- Чат в прямом эфире
- VOD (временное сохранение записи стрима)
- Создание клипов/хайлайтов стрима
- Просмотр клипов/хайлайтов и VOD

### Ключевые продуктовые решения
- При стриминге и при просмотре стриме используется один и тот же аккаунт
- Временное хранение записей трансляций для всех пользователей при активации соотвествущей функции (от 7 для простых пользователей до 2 месяцев для партнерских каналов) [^1]
- При просмотре записи есть реплей чата (повторение чата, как это было на стриме)
- Поддержка рекомендаций на основе каналов в подписках и текущего просматриваемого стрима

### Целевая аудитория
#### Метрики
- 240M MAU [^2]
- 35M DAU [^2]
- Стреднее количество одновременных зрителей в августе 2025 - 2М [^3]
- Количество часов просмотра в августе 2025 - 1498М [^3]
- Количество стримеров в августе 2025 - 7М [^3]
- Среднее количество одновременных стримов за август 2025 - 89K [^3]
- Процент пользователей мобильных устройств - 35% [^4]

#### Распределение аудитории по возрасту
- 52% - 25-34 лет [^5]
- 22% - 35-44 лет [^5]

#### Распределение аудитории по полу
- 72.26% - мужчины [^5]
- 27.74% - женщины [^5]

#### Распределение аудитории по Странам
Только десктоп пользователи за май 2025 [^6]

|  Страна | % пользователей |
| ------- | --------------- |
| США     | 23.6          |
| Россия | 9.79 |
| Германия | 8.69 |
| Франция | 6.53 |
| Испания | 4.08 |
| Остальные | 47.24 |

## 2. Рассчет нагрузки

### Продуктовые метрики
- 240M MAU [^2]
- 35M DAU [^2]
- 1M ежедневных стримов [^3]

#### Действия пользоватей по типам
| Тип | В день от одного пользователя | В день от всех пользователей | Примечание|
| --- | ----------------------------- | ---------------------------- | --- |
| Регистрация/авторизация | 0.15 | 500K [^7] + 5M = 5.5M | Количество логинов из 1/7 от DAU |
| Стриминг (время) | 3.6 минут* | 2.1М часов [^3] | *на DAU |
| Стриминг (количество) | 0.028* | 1М [^3] | *на DAU |
| Просмотр стрима (время) | 1.37 часов | 48M часов [^3] | из источника |
| Просмотр стрима (количество) | 0.06 | 2.1M [^3] | из источника |
| Подписка | 1.2 | 60М | при допущении, что пользователь подписывается раз в неделю |
| Отправка сообщения в чат | 2 | 70M | ~800 в секунду [^8] |
| Создание VOD | 0.0142 | 500K | из расчета, что половину стримеров сохраняют стримы |
| Создание клипа | 0.142 | 5M | из рассчета, что на каждый стрим делается 5 клипов |
| Просмотр VOD/клипа | 0.28 | 10M | по аналогии, что зрителей в 2 раза больше созданного контента |

### Технические метрики

#### Занимаемое место
##### Пользователи
| Тип | Занимаемое место (одним пользователем) |
| -- | --------- |
| Аватар | 100КБ |
| Баннер | 100КБ |
| Мета-данные | ~несколько килобайт |
| Итог | ~200КБ |

##### Контент

| Тип | Занимаемое место (в общем) | Примечание |
| --- | ---------------- | ------ |
| Стримы (1) | 5535,16 ТБ / 2 мес | Не растет, так как старые записи удаляются |
| Чат (2) | 2.142 ТБ / 2 мес | Не растет, так как старые записи удаляются |
| Клипы (3) | 21,47 ТБ / день | Хранятся вечно |


(1) Twitch по умолчанию устанавливает стрим в 1080p 60 FPS 6000 КБит/сек. 6000 * 60 * 60 = 2,7 ГБ за час трансляции. 2.1М / 2 (из расчета, что половину стримеров сохраняют стримы) * 2,7 Гб = 5535,16 ТБ на два месяца (максимальная длительность стрима). \
(2) Максимальная длина сообщения на Twitch 255 символов [^9]. Используется кодировка UTF-8 => 2 байта на символ в смешанном тексте. 70М * 2 Байта * 255 = 35.7 Гб в день. 35.7 Гб * 50 = 2.142 Тб в 2 месяца, так как хранятся со стримами и удалятся вместе с ним. \
(3) Максимальная длина клина - 60 секунд [^10], 6000 Кбит * 60 = 45 МБ для одного клипа. 45 МБ * 500К = 21,47 ТБ в день на всех пользователей.

### Сетевой трафик
Twitch использует RMTP который по TCP отправляет пакеты на каждый кадр ~60 раз в секунду для видео.

| Тип | Пиковый RPS | Пиковый трафик (Гбит/c) |
| --- | --------- | -------------------- |
| Регистрация/авторизация | 63 | - |
| Стриминг | 7.26M | 90 |
| Просмотр стрима | 180M | 18000 |
| Подписка | 700 | - |
| Отправка сообщения в чат | 1000 [^8] | 0.005 |
| Создание VOD (1) | 0 | 0 |
| Создание клипа | 57 | - |
| Просмотр VOD/клипа | 115 | 41 |

(1) VOD записывается во время стрима, поэтому не требует дополнительных запросов.

## Глобальная балансировка нагрузки
### Функциональное разбиение по доменам
Основную нагрузку на сервис представляет стриминг и просмотр стримов, исходя из этого трафик разделяется на RTMP сервера и обычные, обслуживающие остальные запросы.
### Обоснование расположения ДЦ
|  Страна | % пользователей |
| ------- | --------------- |
| США     | 23.6          |
| Россия | 9.79 |
| Германия | 8.69 |
| Франция | 6.53 |
| Испания | 4.08 |
| Остальные | 47.24 |
Расположение берется из количества десктоп пользователей по странам. 
Наибольшее количество пользователей из одной страны в США, поэтому там нужно несколько ДЦ. 
Аналогично для Европейских стран.

<img src="https://cdn.escharts.com/media/quick-upload/2023/01/Twitch_Languages-3780ba1adf29bb709fa81d5383cf4c81.png">
Исходя из большего процента испаноязычных зрителей, чем зрителей из Испании следует, что ~6% зрителей из Южной Америки и Мексики.

| Расположение ДЦ      | Регион             | RPS, млн | Гбит/с |
| -------------------- | ------------------ | -------: | -----: |
| Франкфурт            | Европа             |       22 |   2100 |
| Ашберн, Вирджиния    | США (Восток)       |       16 |   1500 |
| Огайо                | США (Восток)       |       16 |   1500 |
| Портленд, Орегон     | США (Запад)        |       16 |   1500 |
| Стокгольм            | Европа             |       13 |   1200 |
| Париж                | Европа             |       12 |   1200 |
| Мадрид               | Европа             |        8 |    700 |
| Сан-Паулу            | Южная Америка      |        7 |    700 |
| Лондон               | Европа             |        7 |    600 |
| Милан                | Европа             |        6 |    600 |
| Ирландия             | Европа             |        6 |    600 |
| Мумбаи               | Азия               |        6 |    600 |
| Сеул                 | Азия               |        6 |    600 |
| Гонконг              | Азия               |        6 |    600 |
| Осака                | Азия               |        6 |    600 |
| Тайбэй               | Азия               |        6 |    600 |
| Нарита               | Азия               |        6 |    600 |
| Манила               | Азия               |        6 |    600 |
| Сингапур             | Азия               |        6 |    600 |
| Сидней               | Океания            |        6 |    600 |

 
## Список источников
[^1]: https://help.twitch.tv/s/article/video-on-demand 
[^2]: https://resourcera.com/data/social/twitch-statistics/
[^3]: https://twitchtracker.com/
[^4]: https://www.demandsage.com/twitch-users/
[^5]: https://analyzify.com/statsup/twitch#user-audience
[^6]: https://www.statista.com/statistics/511558/twitch-traffic-by-country/
[^7]: https://twitchinsights.net/accounts
[^8]: https://stats.streamelements.com/c/global
[^9]: https://help.twitch.tv/s/article/guide-to-custom-messages?language=ru
[^10]: https://help.twitch.tv/s/article/moments?language=ru
