# Twitch
## 1. Тема и целевая аудитория
**Тема** - стриминговый сервис
### Функционал MVP:
- Регистрация/авторизация
- Создание стрима (включая установление соединение для стриминга видео)
- Просмотр стрима (включая стриминг видео)
- Подписка
- Чат в прямом эфире
- VOD (временное сохранение записи стрима)
- Создание клипов/хайлайтов стрима
- Просмотр клипов/хайлайтов и VOD

### Ключевые продуктовые решения
- При стриминге и при просмотре стриме используется один и тот же аккаунт
- Временное хранение записей трансляций для всех пользователей при активации соотвествущей функции (от 7 для простых пользователей до 2 месяцев для партнерских каналов) [^1]
- При просмотре записи есть реплей чата (повторение чата, как это было на стриме)
- Поддержка рекомендаций на основе каналов в подписках и текущего просматриваемого стрима

### Целевая аудитория
#### Метрики
- 240M MAU [^2]
- 35M DAU [^2]
- Стреднее количество одновременных зрителей в августе 2025 - 2М [^3]
- Количество часов просмотра в августе 2025 - 1498М [^3]
- Количество стримеров в августе 2025 - 7М [^3]
- Среднее количество одновременных стримов за август 2025 - 89K [^3]
- Процент пользователей мобильных устройств - 35% [^4]

#### Распределение аудитории по возрасту
- 52% - 25-34 лет [^5]
- 22% - 35-44 лет [^5]

#### Распределение аудитории по полу
- 72.26% - мужчины [^5]
- 27.74% - женщины [^5]

#### Распределение аудитории по Странам
Только десктоп пользователи за май 2025 [^6]

|  Страна | % пользователей |
| ------- | --------------- |
| США     | 23.6          |
| Россия | 9.79 |
| Германия | 8.69 |
| Франция | 6.53 |
| Испания | 4.08 |
| Остальные | 47.24 |

## 2. Рассчет нагрузки

### Продуктовые метрики
- 240M MAU [^2]
- 35M DAU [^2]
- 1M ежедневных стримов [^3]

#### Действия пользоватей по типам
| Тип | В день от одного пользователя | В день от всех пользователей | Примечание|
| --- | ----------------------------- | ---------------------------- | --- |
| Регистрация/авторизация | 0.15 | 500K [^7] + 5M = 5.5M | Количество логинов из 1/7 от DAU |
| Стриминг (время) | 3.6 минут* | 2.1М часов [^3] | *на DAU |
| Стриминг (количество) | 0.028* | 1М [^3] | *на DAU |
| Просмотр стрима (время) | 1.37 часов | 48M часов [^3] | из источника |
| Просмотр стрима (количество) | 0.06 | 2.1M [^3] | из источника |
| Подписка (бесплатная) | 1.2 | 60М | при допущении, что пользователь подписывается раз в неделю |
| Отправка сообщения в чат | 2 | 70M | ~800 в секунду [^8] |
| Создание VOD | 0.0142 | 500K | из расчета, что половину стримеров сохраняют стримы |
| Создание клипа | 0.142 | 5M | из рассчета, что на каждый стрим делается 5 клипов |
| Просмотр VOD/клипа | 0.28 | 10M | по аналогии, что зрителей в 2 раза больше созданного контента |

### Технические метрики

#### Занимаемое место
##### Пользователи
| Тип | Занимаемое место (одним пользователем) |
| -- | --------- |
| Аватар | 100КБ |
| Баннер | 100КБ |
| Мета-данные | ~несколько килобайт |
| Итог | ~200КБ |

##### Контент

| Тип | Занимаемое место (в общем) | Примечание |
| --- | ---------------- | ------ |
| Стримы (1) | 340 ПБ / 2 мес | Не растет, так как старые записи удаляются |
| Чат (2) | 1.2 ТБ / 2 мес | Не растет, так как старые записи удаляются |
| Клипы (3) | 55 ТБ / день | Хранятся вечно |


(1) Twitch по умолчанию устанавливает стрим в 1080p 60 FPS 6000 КБит/сек. 6000 * 60 * 60 = 2,7 ГБ за час трансляции. 2.1М * 60 (из расчета, что половину стримеров сохраняют стримы) * 2,7 Гб = 340 ПБ на два месяца (максимальная длительность стрима). \
(2) Максимальная длина сообщения на Twitch 255 символов [^9]. Используется кодировка UTF-8 => 1.1 байта на символ в смешанном тексте (в основном используется английский). 70М * 1.1 Байта * 255 = 20 Гб в день. 20 Гб * 60 = 1.2 Тб в 2 месяца, так как хранятся со стримами и удалятся вместе с ним. \
(3) Максимальная длина клина - 60 секунд [^10]. Возьмем за среднее 30 секунд и качество также в половино максимального 3000 Кбит/c. 3000 Кбит * 30 = 11 МБ для одного клипа. 11 МБ * 5M = 55 ТБ в день на всех пользователей.

### Сетевой трафик


| Тип | Пиковый RPS | Пиковый трафик (Гбит/c) |
| --- | --------- | -------------------- |
| Регистрация/авторизация | 63 | - |
| Стриминг | 34 (1) | 525 (2) |
| Просмотр стрима | 100 (1) | 8400 (3) |
| Подписка | 700 | - |
| Отправка сообщения в чат | 1000 [^8] | 0.005 |
| Создание VOD (1) | 0 | 0 |
| Создание клипа | 57 | - |
| Просмотр VOD/клипа | 115 | 41 |

(1) В RMTP выполняется 3 запроса, которые учитываются в RPS: connect, play/publish и play_done/done. То есть на одного зрителя/стримера 2 запроса. В пике на Twitch на всех стримах примерно 3М зрителей [^3]. 3 * 3M / (24 * 60 * 60) = 100 - для зрителей. Стримов в день ~= 1М, то есть 3 * 1M / (24 * 60 * 60) = 34. \
(2) 2.1М часов стримов в день. Стримеры используются в основном настройки по умолчанию в виде 6000 Кбит/c. 2.1М * (60 * 60) * 6000 Кбит/c / (24 * 60 * 60) = 525 Гбит/c \
(3) Из таблицы распределения трафика по зрителям (примерная) можно посчитать средний трафик в секунду на зрителя 2400 + 1575 + 225 + 56 + 12 ~ 4200 Кбит/с. Отсюда можем весь трафик за день на зрителей 48M часов распределить на секунды. 48М * (60 * 60) * 4200 Кбит/c / (24 * 60 * 60) = 8400 Гбит

| Разрешение | Трафик (Кбит/c) | Доля |
| --- | --------- | -------------------- |
| 1080p | 6000 | 40 |
| 720p | 4500 | 35 |
| 480p | 1500 | 15 |
| 360p | 800 | 7 |
| 240p | 400 | 3 |

(*) VOD записывается во время стрима, поэтому не требует дополнительных запросов.

## 3. Глобальная балансировка нагрузки
### Функциональное разбиение по доменам
Основную нагрузку на сервис представляет стриминг и просмотр стримов, исходя из этого трафик разделяется на RTMP сервера и обычные, обслуживающие остальные запросы.\
- contribute.live-video.net - RMTP
- twitch.tv - основной домен
- cdn.twitch.tv - CDN для статики (конкретно на Twitch используется домен не связанный с twitch.tv)
### Обоснование расположения ДЦ
|  Страна | % пользователей |
| ------- | --------------- |
| США     | 23.6          |
| Россия | 9.79 |
| Германия | 8.69 |
| Франция | 6.53 |
| Испания | 4.08 |
| Остальные | 47.24 |

Наибольшее количество пользователей из одной страны в США, поэтому там нужно несколько ДЦ.
Аналогично для Европейских стран. 

<img src="https://cdn.escharts.com/media/quick-upload/2023/01/Twitch_Languages-3780ba1adf29bb709fa81d5383cf4c81.png">
Исходя из большего процента испаноязычных зрителей, чем зрителей из Испании следует, что ~6% зрителей из Южной Америки и Мексики.

Общий RPS ~= 2050, Трафик ~= 9000 Гбит/c

| Расположение ДЦ   | Регион        |  Доля | RPS      | Гбит/с |
| ----------------- | ------------- | ----: | -------: | -----: |
| Франкфурт         | Европа        | 11.6% |      240 |   1040 |
| Ашберн, Вирджиния | США (Восток)  |  8.5% |      176 |    762 |
| Огайо             | США (Восток)  |  8.5% |      176 |    762 |
| Портленд, Орегон  | США (Запад)   |  8.5% |      176 |    762 |
| Стокгольм         | Европа        |  6.8% |      141 |    610 |
| Париж             | Европа        |  6.5% |      134 |    583 |
| Мадрид            | Европа        |  4.1% |       85 |    368 |
| Сан-Паулу         | Южная Америка |  4.0% |       83 |    359 |
| Лондон            | Европа        |  3.5% |       72 |    314 |
| Милан             | Европа        |  3.4% |       70 |    305 |
| Ирландия          | Европа        |  3.4% |       70 |    305 |
| Мумбаи            | Азия          |  3.4% |       70 |    305 |
| Сеул              | Азия          |  3.4% |       70 |    305 |
| Гонконг           | Азия          |  3.4% |       70 |    305 |
| Осака             | Азия          |  3.4% |       70 |    305 |
| Тайбэй            | Азия          |  3.4% |       70 |    305 |
| Нарита            | Азия          |  3.4% |       70 |    305 |
| Манила            | Азия          |  3.4% |       70 |    305 |
| Сингапур          | Азия          |  3.4% |       70 |    305 |
| Сидней            | Океания       |  3.4% |       70 |    305 |


*Расположение серверов взято из api twitch https://ingest.twitch.tv/ingests*

### Схема DNS балансировки
Для направления на близжайший ДЦ использует Geo DNS, так как ДЦ находятся по всему миру.
Могут возникать проблемы с RTMP соединением (stateful), так как при смене маршрута до Anycast IP трафик может перейти в другой узел, что приведет к разрыву сесии. Поэтому используется Geo DNS, который будет отдавать адрес конкретного ДЦ.
### Схема Anycast балансировки
Сервера объединяются под одним Anycast IP и по BGP направляются в близжайшую группу ДЦ. Используется для статики и не RTMP стриминга.
Географически близкие сервера объединяются под одним Anycast IP.
| Часть света          | Сервера                                                                                                                           |
| -------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| **Северная Америка** | Ашберн, Вирджиния (США); Огайо (США); Портленд, Орегон (США)                                                                      |
| **Южная Америка**    | Сан-Паулу (Бразилия)                                                                                                              |
| **Европа**           | Стокгольм (Швеция); Франкфурт (Германия); Милан (Италия); Париж (Франция); Лондон (Великобритания); Ирландия; Мадрид (Испания)    |
| **Азия**             | Мумбаи (Индия); Сеул (Республика Корея); Гонконг; Осака (Япония); Тайбэй (Тайвань); Нарита (Япония); Манила (Филиппины); Сингапур |
| **Океания**          | Сидней (Австралия)                                                                                                                |

## 4. Локальная банасировка нагрузки

### Стриминг
В качестве балансировщика используется LVS Virtual Server via Direct Routing, так как обладает наибольшей производительностью, но необходимо держать сервера в одной физической сети
В NGINX будет использоваться модуль stream, который будет распределять подключения по стратегии Least Connections.
### HTTP запросы
Обрабытваются на уровне L7 по алгоритму Least Connections

#### SSL Termination
Балансировщик на уровне L7 будет дешифровать данные и передавать по HTTP.
Так как RPS достаточно мал, SSL Termination не будет сильно влиять на производительность.
### Резервирование
На каждый ДЦ резервируется N + 1 балансировщиков относительно необходимого по трафику
### Отказоустойчивость
Используется keepalived для проверки доступности балансировщика и его замены в случае падения

### Рассчет необходимого количества балансировщиков
Допущения:
- L4 балансировщик имеет пропускную способность 100 Гбит/c (для 100GbE сетевой карты)
- одного L7 балансировщика достаточно для имеющегося RPS для обычных запросов [^11] + 1 для отказоустойчивости

| Расположение ДЦ   | Регион        | Гбит/с | N (L4) | N (L7) |
| ----------------- | ------------- | -----  | ----- | --- |
| Франкфурт         | Европа        |   1040 | 13    | 2 |
| Ашберн, Вирджиния | США (Восток)  |    762 | 9 | 2 |
| Огайо             | США (Восток)  |    762 | 9 | 2 |
| Портленд, Орегон  | США (Запад)   |    762 | 9 | 2 |
| Стокгольм         | Европа        |    610 | 8 | 2 |
| Париж             | Европа        |    583 | 7 | 2 |
| Мадрид            | Европа        |    368 | 5 | 2 |
| Сан-Паулу         | Южная Америка |    359 | 5 | 2 |
| Лондон            | Европа        |    314 | 4 | 2 |
| Милан             | Европа        |    305 | 4 | 2 |
| Ирландия          | Европа        |    305 | 4 | 2 |
| Мумбаи            | Азия          |    305 | 4 | 2 |
| Сеул              | Азия          |    305 | 4 | 2 |
| Гонконг           | Азия          |    305 | 4 | 2 |
| Осака             | Азия          |    305 | 4 | 2 |
| Тайбэй            | Азия          |    305 | 4 | 2 |
| Нарита            | Азия          |    305 | 4 | 2 |
| Манила            | Азия          |    305 | 4 | 2 |
| Сингапур          | Азия          |    305 | 4 | 2 |
| Сидней            | Океания       |    305 | 4 | 2 |

## 5. Логическая схема БД

<img width="1234" height="860" alt="Untitled" src="https://github.com/user-attachments/assets/d6d2307f-234a-44f3-b13c-5208e8e27822" />

### Размеры полей
| USER_ACCOUNT        | CHANNEL                | STREAM            | RTMP_INGEST_SESSION       | SUBSCRIPTION       | CHAT_MESSAGE      | MEDIA_OBJECT         | VOD_ASSET                | CLIP                  |
| ------------------- | ---------------------- | ----------------- | ------------------------- | ------------------ | ----------------- | -------------------- | ------------------------ | --------------------- |
| id (16 Б)           | id (16 Б)              | id (16 Б)         | id (16 Б)                 | follower_id (16 Б) | id (16 Б)         | id (16 Б)            | id (16 Б)               | id (16 Б)            |
| email (255 Б)       | user_id (16 Б)         | channel_id (16 Б) | stream_id (16 Б)          | channel_id (16 Б)  | stream_id (16 Б)  | kind (1 Б)           | playlist_media_id (16 Б) | creator_id (16 Б)     |
| username (32 Б)     | display_name (128 Б)   | title (128 Б)     | ingest_point (16 Б)       | created_at (8 Б)   | user_id (16 Б)    | storage_url (200 Б)  | stream_id (16 Б)        | stream_id (16 Б)      |
| pass_hash (60 Б)    | stream_key_hash (60 Б) | status (1 Б)      | encoder_ip (16 Б)         |                    | offset_ms (8 Б)   | size_bytes (8 Б)     | playlist_media_id (16 Б) | start_ms (4 Б)        |
| created_at (8 Б)    | is_partner (1 Б)       | started_at (8 Б)  | presented_key_hash (60 Б) |                    | content (280 Б)  | checksum (32 Б)      | duration_sec (4 Б)       | duration_ms (4 Б)     |
| last_login_at (8 Б) | avatar_media_id (16 Б) | ended_at (8 Б)    | encoder_cfg (JSON, 64 Б)  |                    | meta (JSON, 64 Б) | extra (JSON, 64 Б)   | total_size_bytes (8 Б)   | video_media_id (16 Б) |
|                     | banner_media_id (16 Б) | vod_enabled (1 Б) | started_at (8 Б)          |                    | created_at (8 Б)  | created_at (8 Б)     | created_at (8 Б)         | thumb_media_id (16 Б) |
|                     | created_at (8 Б)       | tags (JSON, 64 Б) | ended_at (8 Б)            |                    |                   | ttl_expires_at (8 Б) |                          | created_at (8 Б)      |


### Рассчеты для таблиц
| Сущность                | Вес записи | Строк/сутки (оценка) | Прирост/сутки | Примечания                                                                         |
| ----------------------- | ---------: | -------------------: | ------------: | ---------------------------------------------------------------------------------- |
| USER_ACCOUNT        |      379 Б |          500К | 190 МБ | Регистрации/день (0.5M)                                                           |
| CHANNEL          |      261 Б |          500K | 130 МБ | Канал на пользователя                                                              |
| SUBSCRIPTION        |       40 Б |       60M |  2.4 ГБ | 60M подписок/сутки                                                                 |
| STREAM              |      242 Б |        1M |   240 МБ| Созданий стримов/сутки                                                             |
| RTMP_INGEST_SESSION |      204 Б |        1M |   204 МБ | По одной+ на стрим                                                                 |
| CHAT_MESSAGE        |      408 Б |       70M | 28.5 ГБ | <=255 симв., JSON-мета                                                              |
| VOD_ASSET           |       84 Б |          500K |    42 МБ | VOD создают 50% стримов                                                           |
| CLIP             |       96 Б |        5M |   480 МБ | 5M клипов/сутки                                                                   |
| MEDIA_OBJECT       |      337 Б |      11M |  3.7 ГБ | Оценка: 2 на VOD (плейлист+превью) 1M/сутки + 2 на клип (видео+превью) 10M/сутки |

TTL/накопление: VOD и чат-реплей живут до 60 дней; клипы — бессрочно. \
В хранилище из-за TTL: VOD_ASSET = 30M -> 2.5 ГБ метаданных; CHAT_MESSAGE = 4.2B -> 1.71 TB; MEDIA_OBJECT (только VOD-связанные, 2/стрим) = 60M -> 20 ГБ. Клип-объекты копятся без TTL 10M/сутки.

### QPS
| Cущность                  | Read QPS | Write QPS | Примечания |
| ----------------------- | -------------: | --------------: | ----------: |
| USER_ACCOUNT        |            60 |              6 | |
| CHANNEL             |           5 |              6 | В основном кэш 550 -> 5 (при промахе 1%) |
| SUBSCRIPTION        |           100 |        700 | |
| STREAM              |            5 |             12 | Аналогично каналам  |
| RTMP_INGEST_SESSION |              - |             12 | |
| CHAT_MESSAGE        |            50 |        810 | лайв в буфере; R: только для VOD (50% от клипов и VOD) |
| VOD_ASSET           |           0.5 |              6 | R: 50 -> 0.5 (при промахе 1%) |
| CLIP                |            0.5 |             60 | R: 50 -> 0.5 (при промахе 1%)  |
| MEDIA_OBJECT        |           2 |             120 | W: 2 на VOD + 2 на клип, R: 200 -> 2 (при промахе 1%) |

### Требования консистентности
- Операции создания пользователя + канала и стрима + RTMP сессии должны быть атомарными.
- Счетчики онлайна/подписок/просмотров




 
## Список источников
[^1]: https://help.twitch.tv/s/article/video-on-demand 
[^2]: https://resourcera.com/data/social/twitch-statistics/
[^3]: https://twitchtracker.com/
[^4]: https://www.demandsage.com/twitch-users/
[^5]: https://analyzify.com/statsup/twitch#user-audience
[^6]: https://www.statista.com/statistics/511558/twitch-traffic-by-country/
[^7]: https://twitchinsights.net/accounts
[^8]: https://stats.streamelements.com/c/global
[^9]: https://help.twitch.tv/s/article/guide-to-custom-messages?language=ru
[^10]: https://help.twitch.tv/s/article/moments?language=ru
[^11]: https://blog.nginx.org/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers
